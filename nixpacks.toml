[build]
phases = [
  { name = "install", commands = ["npm ci"] },
  { name = "build", commands = ["npm run build"] },
  { name = "migrate", commands = ["npm run migrate"] },
  { name = "seed", commands = ["npm run seed:products"] }
]

# Do not install OS packages via APT (prevents mirror/network failures).
packages = []

# Environment variables
[env]
NODE_ENV = "production"
PORT = "3000"
HOST = "0.0.0.0"
# Pricing configuration
DEFAULT_GST_RATE = "0.18"
PRICE_UPDATE_REMINDER_TIME = "08:00"
PDF_RETENTION_DAYS = "7"
# Database configuration
AIRTABLE_BASE_ID = ""
AIRTABLE_API_KEY = ""
AIRTABLE_PRODUCTS_TABLE_NAME = "Products"
# API configuration
DEEPSEEK_API_KEY = ""
ACCOUNT_SID = ""
AUTH_TOKEN = ""
TWILIO_WHATSAPP_NUMBER = ""

# Start command configuration
[start]
command = "npm run start:prod"

# Health check configuration
[health_check]
path = "/health"
interval = "30s"
timeout = "10s"
retries = 3
start_period = "40s"
success_threshold = 3
failure_threshold = 5

# Logging configuration
[logging]
format = "json"
level = "info"

# Resource limits
[limits]
cpu = "1.5"
memory = "1.5Gi"
pids = 200
max_file_descriptors = 8192
open_files = 8192

# Deployment configuration
[deploy]
# Number of instances to run
instances = 2

# Auto-scaling configuration
[deploy.autoscaling]
min_instances = 2
max_instances = 5
cpu_threshold = 70
memory_threshold = 80
scale_up_cooldown = "3m"
scale_down_cooldown = "5m"

# Network configuration
[deploy.network]
# Port mapping
port = 3000
# Health check port
health_check_port = 3000
# Security headers
security_headers = true
# CORS configuration
cors_allowed_origins = ["https://yourdomain.com"]
cors_allowed_methods = ["GET", "POST", "PUT", "DELETE"]
cors_allowed_headers = ["Content-Type", "Authorization"]

# Security configuration
[deploy.security]
# Run as non-root user
user = "node"
# Read-only root filesystem
read_only_root_filesystem = true
# Security context
run_as_non_root = true
allow_privilege_escalation = false
read_only_root_filesystem = true
run_as_user = 1000
run_as_group = 1000

# Volume mounts (if needed)
[volumes]
# Temporary directory for audio processing
tmp = "/tmp"
# FFmpeg cache directory
ffmpeg_cache = "/opt/ffmpeg/cache"

# Labels for metadata
[labels]
maintainer = "your-email@example.com"
version = "1.0.0"
description = "WhatsApp Inventory Management System"
org_opencontainers_image_title = "StockGuard"
org_opencontainers_image_description = "WhatsApp-based inventory management system"
org_opencontainers_image_version = "1.0.0"
org_opencontainers_image_authors = "Your Name"
org_opencontainers_image_vendor = "Your Company"
org_opencontainers_image_documentation = "https://github.com/yourusername/stockguard#readme"
org_opencontainers_image_source = "https://github.com/yourusername/stockguard"
org_opencontainers_image_licenses = "MIT"

# Annotations for additional metadata
[annotations]
com_example_commit_sha = "${COMMIT_SHA}"
com_example_commit_ref = "${COMMIT_REF}"
com_example_build_date = "${BUILD_DATE}"
com_example_build_url = "${BUILD_URL}"

# Cache configuration
[cache]
# NPM cache
npm = "/root/.npm"
# FFmpeg cache
ffmpeg = "/opt/ffmpeg/cache"
# Build cache
build = "/app/.cache"

# Experimental features
[experimental]
# Enable experimental features
enabled = true
# Experimental build settings
use_build_cache = true
use_multi_stage_builds = true
optimize_image_size = true
enable_ai_features = true
enable_analytics = true

# Development configuration (for dev environment)
[dev]
# Development environment variables
NODE_ENV = "development"
LOG_LEVEL = "debug"
# Development start command
command = "npm run dev"
# Development health check
health_check_path = "/health"
health_check_interval = "10s"
health_check_timeout = "5s"
health_check_retries = 2
health_check_start_period = "10s"
# Development resource limits
cpu = "0.5"
memory = "512Mi"
pids = 50

# Production configuration (for prod environment)
[prod]
# Production environment variables
NODE_ENV = "production"
LOG_LEVEL = "info"
# Production start command
command = "npm run start:prod"
# Production health check
health_check_path = "/health"
health_check_interval = "30s"
health_check_timeout = "10s"
health_check_retries = 3
health_check_start_period = "40s"
# Production resource limits
cpu = "1"
memory = "1Gi"
pids = 100
# Production scaling
min_instances = 2
max_instances = 5
cpu_threshold = 70
memory_threshold = 80
scale_up_cooldown = "3m"
scale_down_cooldown = "5m"
# Production security
run_as_non_root = true
read_only_root_filesystem = true
allow_privilege_escalation = false

# Caching configuration
[caching]
# Static file caching
static_files_max_age = "1h"
# API response caching
api_responses_max_age = "5m"

# Database connection pooling
[database]
pool_size = 10
connection_timeout = "30s"
max_lifetime = "1h"

# Background job configuration
[jobs]
# Daily summary job
daily_summary_schedule = "0 23 * * *"
daily_summary_timezone = "Asia/Kolkata"
# Price update reminder job
price_reminder_schedule = "0 8 * * *"
price_reminder_timezone = "Asia/Kolkata"
# PDF cleanup job
pdf_cleanup_schedule = "0 2 * * *"
pdf_cleanup_timezone = "Asia/Kolkata"
